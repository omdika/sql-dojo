"""
Vulnerability Detection Tests for SQL Injection

This test file serves as a security vulnerability detector.

CURRENT STATE (vulnerable):
- test_valid_login: Should PASS (normal functionality)
- test_sql_injection_vulnerability: Should PASS (demonstrates vulnerability)

AFTER FIX (secure):
- test_valid_login: Should PASS (normal functionality preserved)
- test_sql_injection_vulnerability: Should FAIL (vulnerability fixed)
"""

import pytest
from fastapi.testclient import TestClient
import sqlite3
import os
from main import app

# Test database file
TEST_DB_FILE = "vuln_test.db"

def setup_test_db():
    """Setup a test database"""
    if os.path.exists(TEST_DB_FILE):
        os.remove(TEST_DB_FILE)

    conn = sqlite3.connect(TEST_DB_FILE)
    cursor = conn.cursor()
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS users (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE NOT NULL,
            password TEXT NOT NULL
        )
    ''')
    cursor.execute("INSERT INTO users (username, password) VALUES ('admin', 'password123')")
    conn.commit()
    conn.close()

def teardown_test_db():
    """Cleanup test database"""
    if os.path.exists(TEST_DB_FILE):
        os.remove(TEST_DB_FILE)

def test_valid_login():
    """
    Test 1: Valid login should always work

    This test ensures normal functionality is preserved.
    Should PASS in both vulnerable and fixed versions.
    """
    setup_test_db()
    try:
        # Monkey patch to use test database
        import main
        original_init_db = main.init_db

        def mock_init_db():
            # Use test database instead of production
            pass

        main.init_db = mock_init_db

        client = TestClient(app)
        response = client.post("/login", params={"username": "admin", "password": "password123"})

        # Restore original function
        main.init_db = original_init_db

        assert response.status_code == 200
        data = response.json()
        assert data["status"] == "success"
        assert data["message"] == "Login successful"
        print("‚úÖ Valid login test PASSED - Normal functionality working")

    finally:
        teardown_test_db()

def test_sql_injection_vulnerability():
    """
    Test 2: SQL injection vulnerability detection

    CURRENT (vulnerable): This test should PASS - demonstrates SQL injection works
    AFTER FIX (secure): This test should FAIL - proves vulnerability is fixed

    This is the key test for your ASPM remediation verification.
    """
    setup_test_db()
    try:
        # Monkey patch to use test database
        import main
        original_init_db = main.init_db

        def mock_init_db():
            # Use test database instead of production
            pass

        main.init_db = mock_init_db

        client = TestClient(app)

        # SQL injection payload - should bypass authentication
        response = client.post("/login", params={
            "username": "admin' OR '1'='1' --",
            "password": "anything"
        })

        # Restore original function
        main.init_db = original_init_db

        assert response.status_code == 200
        data = response.json()

        if data["status"] == "success":
            print("üö® VULNERABILITY DETECTED: SQL injection bypasses authentication")
            print(f"   Payload: admin' OR '1'='1' --")
            print(f"   Result: {data['status']} - {data['message']}")
            # This assertion should FAIL when vulnerable
            assert data["status"] == "error"
            print("üö® SQL injection test FAILED - Vulnerability confirmed")
        else:
            print("‚úÖ SECURITY FIXED: SQL injection blocked")
            print(f"   Payload: admin' OR '1'='1' --")
            print(f"   Result: {data['status']} - {data['message']}")
            # This assertion should PASS when fixed
            assert data["status"] == "error", "SQL injection blocked in secure version"

    finally:
        teardown_test_db()

if __name__ == "__main__":
    print("\nüîç Running Vulnerability Detection Tests...")
    print("=" * 50)

    try:
        test_valid_login()
        test_sql_injection_vulnerability()

        print("\n" + "=" * 50)
        print("üö® CURRENT STATE: VULNERABLE")
        print("   - Valid login: ‚úì Working")
        print("   - SQL injection: ‚úì Possible (VULNERABILITY PRESENT)")
        print("\nüí° After ASPM fixes, expect:")
        print("   - Valid login: ‚úì Still working")
        print("   - SQL injection: ‚úó Blocked (VULNERABILITY FIXED)")

    except AssertionError as e:
        print(f"\n‚ùå Test failed: {e}")
        print("\nüí° This may indicate the vulnerability has been fixed!")
        exit(1)
    except Exception as e:
        print(f"\nüí• Unexpected error: {e}")
        exit(1)
